$UserList = Get-Content "C:\Temp\SIPUSers\SIPUSername.txt"

foreach($User in $UserList){
  try{
    #Get the current user account
    $Maibox = Get-Mailbox $User -ErrorAction SilentlyContinue

    if($Maibox -eq $null){ New-Object psobject -Property @{User = $User ; Result = "User mailbox not found" } ; return }

    #Get the primary STMP address
    $PrimarySMTP = $Mailbox.PrimarySMTPAddress.Address
    
    #Add the primary SMTP and prefix 'sip:'
    $SIPAddress = "SIP:$PrimarySMTP"

    #Get all the email addresses
    $EmailAddresses = $Mailbox.EmailAddresses

    #Find the user has SIP?
    $OLDSIPAddress = $EmailAddresses | Where-Object { $_.PrefixString -ilike "sip" }
    if($OLDSIPAddress.Count -eq 0){ New-Object psobject -Property @{User = $User ; Result = "No SIP address found" } ; continue }
    
    if($OLDSIPAddress -ieq $SIPAddress){ New-Object psobject -Property @{User = $User ; Result = "OLD & NEW SIP address are the same" } ; continue }

    #If SIP found, remove it
    [bool]$IsRemoved = $EmailAddresses.Remove($OLDSIPAddress)
    if(-not $IsRemoved){ New-Object psobject -Property @{User = $User ; Result = "Unable to remove SIP address" } ; continue }

    #Add the new sip to the Email Addresses List
    $EmailAddresses.Add($SIPAddress)

    #Apply changed emailaddresses list
    Set-Mailbox $Mailbox.DistinguishedName -EmailAddresses $EmailAddresses -ErrorAction Stop

    New-Object psobject -Property @{User = $User ; Result = "SIP $SIPAddress Added"}
  }catch{
    New-Object psobject -Property @{User = $User ; Result = "Error: $_" }
  }
}
