$UserList = Get-Content "C:\Temp\SIPUSers\SIPUSername.txt"

foreach($User in $UserList){
  try{
    $result = $null
    #Get the current user account
    $Maibox = Get-Mailbox $User

    if($Maibox -eq $null){ $result = New-Object psobject -Property @{User = $User ; Result = "User mailbox not found" } ; return }

    #Get the primary STMP address
    $PrimarySMTP = $Mailbox.PrimarySMTPAddress.Address

    #Get all the email addresses
    $EmailAddresses = $Mailbox.EmailAddresses

    #Find the user has SIP?
    $OLDSIPAddress = $EmailAddresses | Where-Object { $_.PrefixString -ilike "sip" }
    if($OLDSIPAddress -eq $null){ $result = New-Object psobject -Property @{User = $User ; Result = "No SIP address found" } ; continue }

    #If SIP found, remove it
    [bool]$IsRemoved = $EmailAddresses.Remove($SIPAddress)
    if(-not $IsRemoved){ $result = New-Object psobject -Property @{User = $User ; Result = "Unable to remove SIP address" } ; continue }

    #Add the primary SMTP and prefix 'sip:'
    $SIPAddress = "SIP:$PrimarySMTP"
    $IsAdded = $EmailAddresses.Add($SIPAddress)

    #Apply changed emailaddresses list
    Set-Mailbox $Mailbox.DistinguishedName -EmailAddresses $EmailAddresses -ErrorAction Stop

    $result = New-Object psobject -Property @{User = $User ; Result = "SIP $SIPAddress Added"
  }catch{
    $result = New-Object psobject -Property @{User = $User ; Result = "Error: $_"
  }finally{
    $result
  }
}
